name: StackSquad Continuous Integration

on:
  pull_request:
  push:
    branches: ["main", "dev", "*"]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install pytest pytest-cov

    - name: Create testing-documents folders
      run: |
        mkdir -p testing-documents
        mkdir -p testing-documents/coverage
        mkdir -p testing-documents/unit-tests
        mkdir -p testing-documents/integration-tests

    - name: Generate timestamp
      id: time
      run: echo "tstamp=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

    - name: Run Unit Tests With Coverage
      run: |
        pytest backend/test/unit \
          --maxfail=3 \
          --disable-warnings \
          --cov=backend/app \
          --cov-report=xml:testing-documents/coverage/coverage.xml \
          --cov-report=term-missing \
        | tee testing-documents/unit-tests/unit-results-${{ steps.time.outputs.tstamp }}.txt

    - name: Run Integration Tests (append to coverage)
      run: |
        pytest backend/test/integration \
          --maxfail=3 \
          --disable-warnings \
          --cov=backend/app \
          --cov-append \
          --cov-report=xml:testing-documents/coverage/coverage.xml \
          --cov-report=term-missing \
        | tee testing-documents/integration-tests/integration-results-${{ steps.time.outputs.tstamp }}.txt

    - name: Timestamp Final Coverage Report
      run: |
        mv testing-documents/coverage/coverage.xml \
          testing-documents/coverage/coverage-${{ steps.time.outputs.tstamp }}.xml

    - name: Upload testing-documents folder
      uses: actions/upload-artifact@v4
      with:
        name: testing-documents
        path: testing-documents